<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>BLOOP Emulator</title>
<style>
  :root {
    --device-red: #c62828;
    --device-red-dark: #8e0000;
    --screen-scale: 4; /* 128x64 -> 512x256 */
  }
  body {
    background:#111; color:#eee; font:14px/1.4 system-ui, sans-serif;
    min-height:100vh; margin:0; display:grid; place-items:center; padding:24px;
  }
  .device {
    background: var(--device-red);
    border: 2px solid var(--device-red-dark);
    width: calc(128px * var(--screen-scale) + 48px);
    padding: 16px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 0 12px rgba(255,255,255,0.12);
  }
  .screen-wrap {
    background: #000; border-radius: 10px; padding: 8px;
    border: 2px solid #690000;
  }
  canvas {
    image-rendering: pixelated;
    width: calc(128px * var(--screen-scale));
    height: calc(64px * var(--screen-scale));
    display:block;
    margin: 0 auto;
    background: #000;
  }
  .controls {
    margin-top: calc(30px* var(--screen-scale)); 
    display: grid; gap: calc(40px* var(--screen-scale));
    grid-template-columns:repeat(2, calc(40px* var(--screen-scale))); justify-content: center;
  }
  .btn {
    width: calc(40px* var(--screen-scale));  height: calc(40px* var(--screen-scale));
    background:#222; color:#eee; border:2px solid #555;
    border-radius: 50%; padding: 12px 0; font-weight:700; letter-spacing:0.5px;
    box-shadow: inset 0 -3px 0 rgba(255,255,255,0.06);
    cursor:pointer; user-select:none; display: flex;
    transition: transform .05s ease-in;  align-items: center;  justify-content: center; font-size: calc(8px* var(--screen-scale));
    text-transform: uppercase;
  }
  .btn:active { transform: translateY(2px); }
  .btn.pressed { 
    background: #444; 
    box-shadow: inset 0 2px 0 rgba(0,0,0,0.3);
    transform: translateY(2px); 
  }
  .legend { text-align:center; margin-top:10px; opacity:.85; font-size:12px; }
</style>
</head>
<body>
  <div class="device" aria-label="BLOOP ">
    <div class="screen-wrap">
      <canvas id="screen" width="128" height="64" aria-label="game screen"></canvas>
    </div>
    <div class="controls">
      <div class="btn" id="btnA" aria-label="A button">A ◀</div>
      <div class="btn" id="btnB" aria-label="B button">B ▶</div>
    </div>
  </div>

  <script>
    // --- Framebuffer + draw functions used by WASM ---
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d', { alpha: false });
    const W = canvas.width, H = canvas.height;
    const fb = new Uint8Array(W*H);

    function drawPixel(x, y, on) {
      if (x < 0 || y < 0 || x >= W || y >= H) return;
      fb[y*W + x] = on ? 1 : 0;
    }
    
    function clearDisplay() { 
      fb.fill(0); 
      ctx.fillStyle = '#000'; 
      ctx.fillRect(0,0,W,H); 
    }
    
    function updateDisplay() {
      const img = ctx.getImageData(0,0,W,H);
      const d = img.data;
      for (let i=0, p=0; i<fb.length; ++i, p+=4) {
        const v = fb[i] ? 255 : 0;
        d[p]=d[p+1]=d[p+2]=v; d[p+3]=255;
      }
      ctx.putImageData(img,0,0);
    }

    // --- Enhanced input state management ---
    const buttons = [0,0]; // 0:A (Left), 1:B (Right)
    let keyboardButtonStates = [false, false];
    let mouseButtonStates = [false, false];
    
    function isButtonPressed(pin) { 
      return (buttons[pin|0] | 0); 
    }
    
    function updateButtonState(index, pressed) {
      buttons[index] = pressed ? 1 : 0;
      const btn = index === 0 ? document.getElementById('btnA') : document.getElementById('btnB');
      if (pressed) {
        btn.classList.add('pressed');
      } else {
        btn.classList.remove('pressed');
      }
    }

    // Keyboard handling with proper debouncing
    let keyRepeatBlocker = {};
    
    window.addEventListener('keydown', (e) => {
      if (keyRepeatBlocker[e.code]) return; // Block repeats
      keyRepeatBlocker[e.code] = true;
      
      if (e.code === 'ArrowLeft') { 
        keyboardButtonStates[0] = true;
        updateButtonState(0, true);
        e.preventDefault(); 
      }
      if (e.code === 'ArrowRight') { 
        keyboardButtonStates[1] = true;
        updateButtonState(1, true);
        e.preventDefault(); 
      }
    });
    
    window.addEventListener('keyup', (e) => {
      keyRepeatBlocker[e.code] = false;
      
      if (e.code === 'ArrowLeft') { 
        keyboardButtonStates[0] = false;
        if (!mouseButtonStates[0]) updateButtonState(0, false);
        e.preventDefault(); 
      }
      if (e.code === 'ArrowRight') { 
        keyboardButtonStates[1] = false;
        if (!mouseButtonStates[1]) updateButtonState(1, false);
        e.preventDefault(); 
      }
    });

    // Enhanced on-screen button handling
    const btnA = document.getElementById('btnA');
    const btnB = document.getElementById('btnB');

    function setupButton(element, index) {
      function setPressed(pressed) {
        mouseButtonStates[index] = pressed;
        if (pressed || !keyboardButtonStates[index]) {
          updateButtonState(index, pressed || keyboardButtonStates[index]);
        }
      }

      // Mouse events
      element.addEventListener('mousedown', (e) => {
        e.preventDefault();
        setPressed(true);
      });
      
      element.addEventListener('mouseup', (e) => {
        e.preventDefault();
        setPressed(false);
      });
      
      element.addEventListener('mouseleave', (e) => {
        e.preventDefault();
        setPressed(false);
      });

      // Touch events with better handling
      element.addEventListener('touchstart', (e) => {
        e.preventDefault();
        setPressed(true);
      }, { passive: false });
      
      element.addEventListener('touchend', (e) => {
        e.preventDefault();
        setPressed(false);
      }, { passive: false });
      
      element.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        setPressed(false);
      }, { passive: false });
      
      // Prevent context menu
      element.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });
    }

    setupButton(btnA, 0);
    setupButton(btnB, 1);

    // Prevent page scrolling on touch
    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });

    // Emscripten module configuration
    var Module = { 
      canvas,
      onRuntimeInitialized: function() {
        console.log('BLOOP Emulator loaded successfully!');
      }
    };

    // Expose functions for C++ EM_ASM bridges
    window.drawPixel     = drawPixel;
    window.clearDisplay  = clearDisplay;
    window.updateDisplay = updateDisplay;
    window.isButtonPressed = isButtonPressed;
  </script>

  <script src="bloop.js"></script>
</body>
</html>
